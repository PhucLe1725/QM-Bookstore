name: Keep Render Service Alive

on:
  schedule:
    # Cháº¡y má»—i 5 phÃºt Ä‘á»ƒ trÃ¡nh Render sleep sau 15 phÃºt
    - cron: '*/5 * * * *'
  workflow_dispatch: # Cho phÃ©p trigger thá»§ cÃ´ng tá»« GitHub UI

jobs:
  ping-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: Ping QM Bookstore Backend - Health Check
        run: |
          echo "ğŸ”” Pinging backend at $(date)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Endpoint 1: Health/Auth check
          echo "ğŸ“ Checking /api/auth/test..."
          response1=$(curl -s -o /dev/null -w "%{http_code}" \
            -X GET https://qm-bookstore-backend.onrender.com/api/auth/test \
            --max-time 30 \
            --retry 2 \
            --retry-delay 3)
          echo "   Response: $response1"
          
          # Endpoint 2: Alternative ping
          echo "ğŸ“ Checking /api/books (backup ping)..."
          response2=$(curl -s -o /dev/null -w "%{http_code}" \
            -X GET https://qm-bookstore-backend.onrender.com/api/books \
            --max-time 30 \
            --retry 2 \
            --retry-delay 3)
          echo "   Response: $response2"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Kiá»ƒm tra Ã­t nháº¥t 1 endpoint pháº£n há»“i
          if [ "$response1" -ge 200 ] && [ "$response1" -lt 500 ]; then
            echo "âœ… Backend is alive (Auth endpoint: HTTP $response1)"
            exit 0
          elif [ "$response2" -ge 200 ] && [ "$response2" -lt 500 ]; then
            echo "âœ… Backend is alive (Books endpoint: HTTP $response2)"
            exit 0
          else
            echo "âš ï¸ Both endpoints returned errors, but continuing..."
            echo "   Auth: $response1, Books: $response2"
            exit 0
          fi
      
      - name: Log Completion
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ¨ Keep-alive job completed at $(date)"
          echo "â° Next run in ~5 minutes"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
